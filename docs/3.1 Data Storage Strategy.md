# 3.1 Data Storage Strategy

## Overview

This document defines the data storage strategy for Interactive Brokers account and portfolio data, including field mappings from IB API to our database schema.

**Last Updated:** 2025-10-03
**IB API Version:** 10.37.2

---

## Table of Contents

1. [Storage Philosophy](#storage-philosophy)
2. [IB API Field Mappings](#ib-api-field-mappings)
3. [PostgreSQL Schema](#postgresql-schema)
4. [Redis Key Structure](#redis-key-structure)
5. [Data Retention Policy](#data-retention-policy)

---

## Storage Philosophy

### Redis (Real-time/Current State)
**Purpose:** Fast access to current account state
**TTL Strategy:** Short-lived cache for active trading
**Use Cases:**
- Current positions lookup
- Real-time PnL monitoring
- Account summary quick access
- Trading decision support

### PostgreSQL (Historical/Persistent)
**Purpose:** Long-term storage and analysis
**Retention:** 2-year rolling window
**Use Cases:**
- Historical performance analysis
- Audit trail
- Tax reporting
- Strategy backtesting

---

## IB API Field Mappings

### Account Summary Callback

**IB API Signature:**
```python
def accountSummary(self, reqId: int, account: str, tag: str, value: str, currency: str):
```

**Field Mappings:**
| IB API Field | Python Type | DB Column | DB Type | Notes |
|--------------|-------------|-----------|---------|-------|
| account | str | account | VARCHAR(50) | Account identifier |
| tag | str | tag | VARCHAR(100) | Tag name (e.g., "NetLiquidation") |
| value | str | value | DECIMAL(24,4) | Numeric value as string |
| currency | str | currency | VARCHAR(10) | Currency code (e.g., "USD") |

---

### Account Updates - updateAccountValue

**IB API Signature:**
```python
def updateAccountValue(self, key: str, val: str, currency: str, accountName: str):
```

**Field Mappings:**
| IB API Field | Python Type | DB Column | DB Type | Notes |
|--------------|-------------|-----------|---------|-------|
| accountName | str | account | VARCHAR(50) | Maps to 'account' column |
| key | str | key | VARCHAR(100) | Account value key |
| val | str | value | VARCHAR(255) | Value as string |
| currency | str | currency | VARCHAR(10) | Currency code |

---

### Account Updates - updatePortfolio

**IB API Signature:**
```python
def updatePortfolio(self, contract: Contract, position: Decimal, marketPrice: float,
                   marketValue: float, averageCost: float, unrealizedPNL: float,
                   realizedPNL: float, accountName: str):
```

**Field Mappings:**
| IB API Field | Python Type | DB Column | DB Type | Notes |
|--------------|-------------|-----------|---------|-------|
| accountName | str | account | VARCHAR(50) | Account identifier |
| contract.conId | int | contract_id | INTEGER | FK to contracts table |
| contract.symbol | str | symbol | VARCHAR(50) | Ticker symbol |
| contract.secType | str | sec_type | VARCHAR(20) | Security type |
| contract.exchange | str | exchange | VARCHAR(50) | Exchange |
| position | Decimal | position | DECIMAL(28,8) | Number of shares/contracts |
| marketPrice | float | market_price | DECIMAL(24,4) | Current price |
| marketValue | float | market_value | DECIMAL(24,4) | Total position value |
| averageCost | float | avg_cost | DECIMAL(24,4) | Average cost per unit |
| unrealizedPNL | float | unrealized_pnl | DECIMAL(24,4) | Unrealized P&L |
| realizedPNL | float | realized_pnl | DECIMAL(24,4) | Realized P&L |

---

### Positions - position

**IB API Signature:**
```python
def position(self, account: str, contract: Contract, position: Decimal, avgCost: float):
```

**Field Mappings:**
| IB API Field | Python Type | DB Column | DB Type | Notes |
|--------------|-------------|-----------|---------|-------|
| account | str | account | VARCHAR(50) | Account identifier |
| contract.conId | int | contract_id | INTEGER | FK to contracts table |
| position | Decimal | position | DECIMAL(28,8) | Number of shares/contracts |
| avgCost | float | avg_cost | DECIMAL(24,4) | **Note: avgCost not averageCost** |

---

### PnL - pnl (Account-level)

**IB API Signature:**
```python
def pnl(self, reqId: int, dailyPnL: float, unrealizedPnL: float, realizedPnL: float):
```

**Field Mappings:**
| IB API Field | Python Type | DB Column | DB Type | Notes |
|--------------|-------------|-----------|---------|-------|
| dailyPnL | float | daily_pnl | DECIMAL(24,4) | Daily P&L |
| unrealizedPnL | float | unrealized_pnl | DECIMAL(24,4) | Total unrealized P&L |
| realizedPnL | float | realized_pnl | DECIMAL(24,4) | Total realized P&L |

---

### PnL - pnlSingle (Position-level)

**IB API Signature:**
```python
def pnlSingle(self, reqId: int, pos: Decimal, dailyPnL: float, unrealizedPnL: float,
              realizedPnL: float, value: float):
```

**Field Mappings:**
| IB API Field | Python Type | DB Column | DB Type | Notes |
|--------------|-------------|-----------|---------|-------|
| pos | Decimal | position | DECIMAL(28,8) | **Note: pos not position!** |
| dailyPnL | float | daily_pnl | DECIMAL(24,4) | Daily P&L for position |
| unrealizedPnL | float | unrealized_pnl | DECIMAL(24,4) | Unrealized P&L |
| realizedPnL | float | realized_pnl | DECIMAL(24,4) | Realized P&L |
| value | float | value | DECIMAL(24,4) | Current market value |

---

### Contract Object - ALL Fields

**IB API Contract Object:**
```python
contract.conId                      # int
contract.symbol                     # str
contract.secType                    # str
contract.exchange                   # str
contract.primaryExchange            # str
contract.currency                   # str
contract.lastTradeDateOrContractMonth  # str
contract.strike                     # float
contract.right                      # str (P/C)
contract.tradingClass               # str
contract.multiplier                 # str
```

**Complete Field Mappings:**
| IB API Field | Python Type | DB Column | DB Type | Notes |
|--------------|-------------|-----------|---------|-------|
| conId | int | con_id | INTEGER PRIMARY KEY | Contract identifier |
| symbol | str | symbol | VARCHAR(50) | Ticker symbol |
| secType | str | sec_type | VARCHAR(20) | STK, OPT, FUT, etc. |
| exchange | str | exchange | VARCHAR(50) | Trading exchange |
| primaryExchange | str | primary_exchange | VARCHAR(50) | Primary listing exchange |
| currency | str | currency | VARCHAR(10) | Base currency |
| lastTradeDateOrContractMonth | str | last_trade_date | VARCHAR(20) | For derivatives |
| strike | float | strike | DECIMAL(24,4) | For options |
| right | str | right | VARCHAR(1) | P or C for options |
| tradingClass | str | trading_class | VARCHAR(50) | Monthly/weekly indicator |
| multiplier | str | multiplier | VARCHAR(20) | Contract multiplier |
| localSymbol | str | local_symbol | VARCHAR(50) | Local exchange symbol |
| comboLegsDescrip | str | combo_legs_descrip | TEXT | For combo orders |
| includeExpired | bool | include_expired | BOOLEAN | Query parameter |

---

## PostgreSQL Schema

See migration script: `migrations/001_initial_schema.sql`

### Key Design Decisions:

1. **Single Account Design:**
   - Account column exists but optimized for single account
   - Can be extended later if needed

2. **Contract Normalization:**
   - Separate `contracts` table
   - Foreign keys from positions/portfolio to contracts
   - Avoids data duplication

3. **Precision:**
   - DECIMAL(28,8) for positions (fractional shares)
   - DECIMAL(24,4) for PnL and prices

4. **Indexing Strategy:**
   - Time-based queries (most common)
   - Contract-based queries
   - Composite indexes for common patterns

5. **Retention:**
   - 2-year rolling window
   - Automatic cleanup via scheduled job

---

## Redis Key Structure

### Pattern Philosophy
- Hierarchical keys: `ib:domain:identifier:type`
- TTL matches update frequency + buffer
- Hash for related data
- String for simple values

### Account Summary
```
Key: ib:account:{account}:summary:{tag}
Type: String
TTL: 180 seconds (3 minutes)
Value: "{value}"
Currency stored separately: ib:account:{account}:summary:{tag}:currency
```

**Example:**
```
ib:account:U123456:summary:NetLiquidation = "1000000.5000"
ib:account:U123456:summary:NetLiquidation:currency = "USD"
```

### Current Positions
```
Key: ib:account:{account}:positions
Type: Hash
TTL: 300 seconds (5 minutes)
Fields: {contract_id}: JSON
```

**Example:**
```redis
HSET ib:account:U123456:positions 8314 '{"symbol":"IBM","position":100.00000000,"avg_cost":150.0000,...}'
```

### Real-time PnL (Account)
```
Key: ib:account:{account}:pnl
Type: Hash
TTL: 60 seconds
Fields: daily_pnl, unrealized_pnl, realized_pnl, last_update
```

**Example:**
```redis
HMSET ib:account:U123456:pnl
  daily_pnl 5000.5000
  unrealized_pnl 12000.0000
  realized_pnl 3000.0000
  last_update "2025-10-03T14:30:01Z"
```

### Position PnL
```
Key: ib:account:{account}:position:{contract_id}:pnl
Type: Hash
TTL: 60 seconds
Fields: position, daily_pnl, unrealized_pnl, realized_pnl, value
```

**Example:**
```redis
HMSET ib:account:U123456:position:8314:pnl
  position 100.00000000
  daily_pnl 250.0000
  unrealized_pnl 500.0000
  realized_pnl 100.0000
  value 15000.0000
```

### Timestamps
```
Key: ib:account:{account}:last_update:{type}
Type: String
TTL: 86400 seconds (24 hours)
Value: ISO timestamp
```

**Example:**
```
ib:account:U123456:last_update:summary = "2025-10-03T14:27:00Z"
ib:account:U123456:last_update:positions = "2025-10-03T14:30:05Z"
```

---

## Data Retention Policy

### PostgreSQL

**Retention:** 2-year rolling window

**Cleanup Strategy:**
```sql
-- Daily cleanup job (runs at 00:00 UTC)
DELETE FROM account_summary WHERE timestamp < NOW() - INTERVAL '2 years';
DELETE FROM account_values WHERE timestamp < NOW() - INTERVAL '2 years';
DELETE FROM positions WHERE timestamp < NOW() - INTERVAL '2 years';
DELETE FROM pnl_positions WHERE timestamp < NOW() - INTERVAL '2 years';
-- Keep daily PnL longer for annual reports
DELETE FROM pnl_daily WHERE date < NOW() - INTERVAL '3 years';
```

**Implementation:**
- PostgreSQL scheduled job (pg_cron)
- OR Python scheduled task
- Runs daily at 00:00 UTC
- Logs deletion counts

### Redis

**TTL Strategy:**
- Account Summary: 180 seconds (3 min update + buffer)
- Positions: 300 seconds (5 min update + buffer)
- Account PnL: 60 seconds (~1 sec update + buffer)
- Position PnL: 60 seconds (~1 sec update + buffer)
- Timestamps: 86400 seconds (24 hours)

**Auto-expiration:** Redis handles automatically via TTL

---

## Data Flow

### Account Summary
```
IB API → accountSummary() callback
  ↓
Redis: Store with 180s TTL
  ↓
PostgreSQL: Insert if tag in important_tags list
```

### Positions
```
IB API → position() callback
  ↓
Redis: HSET positions hash with 300s TTL
  ↓
PostgreSQL: Insert if position changed
  ↓
Contracts: Upsert contract details if new
```

### PnL
```
IB API → pnl()/pnlSingle() callbacks (~1/sec)
  ↓
Redis: Update hash with 60s TTL
  ↓
PostgreSQL: Snapshot every 5 minutes
  ↓
PostgreSQL: Daily summary at EOD
```

---

## Monitoring

### Key Metrics

1. **Redis Hit Rate:**
   - Target: >95% for positions/summary
   - Monitor: `INFO stats` → keyspace_hits/keyspace_misses

2. **PostgreSQL Performance:**
   - Query time for common patterns
   - Table sizes
   - Index usage

3. **Data Freshness:**
   - Last update timestamps
   - Gap detection between IB updates and storage

4. **Storage Growth:**
   - Row counts per table
   - Disk usage
   - Cleanup job effectiveness

---

## Field Naming Conventions

### Database (snake_case):
- `account`
- `contract_id`
- `avg_cost`
- `daily_pnl`
- `unrealized_pnl`
- `realized_pnl`

### IB API (varies):
- accountSummary: `account`, `tag`, `value`, `currency`
- updateAccountValue: `accountName`, `key`, `val`, `currency`
- updatePortfolio: `accountName`, `averageCost`, `unrealizedPNL`, `realizedPNL`
- position: `account`, `avgCost`
- pnl: `dailyPnL`, `unrealizedPnL`, `realizedPnL`
- pnlSingle: `pos`, `dailyPnL`, `unrealizedPnL`, `realizedPnL`

### Python Code (snake_case):
- `account`
- `contract_id`
- `avg_cost`
- `daily_pnl`
- `unrealized_pnl`
- `realized_pnl`

---

## Important Notes

### IB API Inconsistencies

1. **Account Field:**
   - accountSummary → `account`
   - updateAccountValue → `accountName`
   - position → `account`
   - **Our mapping:** Always use `account`

2. **Average Cost:**
   - updatePortfolio → `averageCost`
   - position → `avgCost`
   - **Our mapping:** Always use `avg_cost`

3. **Position:**
   - updatePortfolio → `position`
   - pnlSingle → `pos`
   - **Our mapping:** Always use `position`

4. **PnL Naming:**
   - IB uses camelCase with capital PnL: `dailyPnL`, `unrealizedPnL`, `realizedPnL`
   - **Our mapping:** snake_case: `daily_pnl`, `unrealized_pnl`, `realized_pnl`

---

## Security Considerations

1. **Sensitive Data:**
   - Account numbers in logs: Masked
   - PnL values: Encrypted at rest (PostgreSQL)
   - Redis: Password protected

2. **Access Control:**
   - PostgreSQL: Role-based access
   - Redis: AUTH enabled
   - API: No exposure of raw account data

---

**End of Document**
