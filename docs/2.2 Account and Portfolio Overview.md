# 2.2 Account and Portfolio Overview

## Scope

This guide explains how Quanticity Capital ingests Interactive Brokers account, position, and PnL data, and how that data flows through the layering of client, service, cache, and persistence components.

---

## Components

- **`IBClient`** – establishes the socket connection and exposes subscription helpers (`reqAccountSummary`, `reqAccountUpdates`, `reqPositions`, `reqPnL`, `reqPnLSingle`).
- **`AccountMixin`** – hosts the IB callbacks and forwards structured payloads to the service layer.
- **`AccountService`** – centralised business logic; performs change detection and coordinates writes to Redis (real-time cache) and PostgreSQL (historical store).
- **Redis** – serves current-state lookups with time-to-live (TTL) semantics.
- **PostgreSQL** – retains audited history, enforces retention, exposes reporting views.

---

## Data Flow

1. **Subscription** – client issues `req*` call; IB pushes data via callback.
2. **Normalisation** – mixin converts IB payloads into Pydantic models (see `src/brokers/ib/models.py`).
3. **Service Orchestration** – `AccountService` evaluates whether data should be cached and/or persisted, based on configurable intervals and change detection.
4. **Storage** – Redis captures latest values with TTL; PostgreSQL stores history, updates contract metadata, and maintains views (see `migrations/001_initial_schema.sql`).

---

## Update Frequencies

| Feed | IB Interval | Redis TTL | Persistence Interval |
|------|-------------|-----------|-----------------------|
| Account Summary | ~3 minutes | 180s | 3 minutes or value change |
| Account Values | ~3 minutes / position change | n/a | 3 minutes or value change |
| Positions | On change / request | 300s | 60s or value change |
| Account PnL | ~1 second | 60s | 60s or value change |
| Position PnL | ~1 second | 60s | 60s or value change |

---

## Operational Notes

- Only two `reqAccountSummary` subscriptions may be live simultaneously per IB restrictions.
- `reqAccountUpdates` is single-account; new subscriptions replace the previous one.
- `reqPositions` is a batch call and must be cancelled to stop updates.
- `reqPnL`/`reqPnLSingle` should be cancelled explicitly to release server-side resources.
- Redis keys follow `ib:account:{account}:*`; ensure environment-specific prefixes if sharing infrastructure.

