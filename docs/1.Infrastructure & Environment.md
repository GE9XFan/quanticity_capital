# Infrastructure & Environment

## Overview

This document describes the infrastructure, environment setup, and system requirements for the Quanticity Capital trading platform.

## System Architecture

### Technology Stack

- **Language**: Python 3.11
- **Database**: PostgreSQL 16.10
- **Cache/Message Broker**: Redis
- **Broker API**: Interactive Brokers TWS API (9.81.1+)
- **Testing**: pytest
- **Development Tools**: black, flake8, mypy

## Environment Setup

### Python Environment

- **Version**: Python 3.11.0 (minimum)
- **Virtual Environment**: venv
- **Location**: `venv/` (gitignored)

**Setup Commands:**
```bash
python3.11 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

### Database

- **System**: PostgreSQL
- **Version**: 16.10 (Homebrew)
- **Host**: localhost
- **Port**: 5432
- **Database Name**: quanticity_capital (configurable)

**Verification:**
```bash
psql --version
# Expected: psql (PostgreSQL) 16.10 (Homebrew)
```

### Cache/Message Broker

- **System**: Redis
- **Host**: localhost
- **Port**: 6379
- **Password**: Not required for local development

**Verification:**
```bash
redis-cli ping
# Expected: PONG
```

### Interactive Brokers API

- **API Version**: 10.37.2 (minimum 9.73)
- **TWS Version**: Build 952.x or higher
- **Installation Source**: https://interactivebrokers.github.io/
- **Trading Mode**: Paper trading (port 7497) / Live trading (port 7496)
- **Status**: ✓ Fully tested and operational

**Important**: The IB API is NOT available via pip. It must be downloaded from the official Interactive Brokers GitHub and installed manually:

```bash
# Download TWS API from https://interactivebrokers.github.io/
# Extract to ~/Downloads/twsapi_macunix
cd ~/Downloads/twsapi_macunix/IBJts/source/pythonclient
python setup.py install
```

**Prerequisites:**
- TWS or IB Gateway must be installed and running
- API must be enabled: Edit → Global Configuration → API → Settings
- "Enable ActiveX and Socket Clients" must be checked

## Project Structure

```
quanticity_capital/
├── .env                        # Environment variables (gitignored)
├── .env.example                # Environment template
├── .gitignore                  # Git ignore rules
├── README.md                   # Project documentation
├── requirements.txt            # Python dependencies
│
├── docs/                       # Documentation
│   ├── 1.Infrastructure & Environment.md
│   └── 2.1 Interactive brokers connection.md
│
├── src/                        # Source code
│   ├── main.py                 # Main application entry
│   └── brokers/                # Broker integrations
│       └── ib/                 # Interactive Brokers
│           ├── __init__.py
│           ├── client.py       # IB API client
│           └── config.py       # IB configuration
│
└── tests/                      # Test suite
    ├── __init__.py
    └── integration/            # Integration tests
        ├── __init__.py
        └── test_ib_connection.py
```

## Configuration Management

### Environment Variables

Configuration is managed through `.env` file. All environment variables are loaded at runtime.

**Template:** `.env.example`

**Key Variables:**

```bash
# Database Configuration
DATABASE_URL=postgresql://username:password@localhost:5432/dbname
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_DB=quanticity_capital
POSTGRES_USER=postgres
POSTGRES_PASSWORD=your_password_here

# Redis Configuration
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# Application Settings
ENVIRONMENT=development
DEBUG=true

# Interactive Brokers API Configuration
IB_HOST=127.0.0.1
IB_PORT=7497        # 7497 for paper, 7496 for live
IB_CLIENT_ID=0
```

### Loading Configuration

```python
import os
from dotenv import load_dotenv

# Load environment variables
load_dotenv()

# Access variables
db_host = os.getenv("POSTGRES_HOST", "localhost")
```

## Dependencies

### Core Dependencies

- **python-dotenv** (1.0.0) - Environment variable management
- **psycopg2-binary** (2.9.9) - PostgreSQL adapter
- **redis** (5.0.1) - Redis client

### Interactive Brokers

- **ibapi** (10.37.2) - Must be installed from official IB source
- **protobuf** (5.29.3) - Required by ibapi for protocol buffers

### Testing

- **pytest** (7.4.3) - Testing framework
- **pytest-asyncio** (0.21.1) - Async testing support
- **pytest-timeout** (2.2.0) - Test timeout support

### Development Tools

- **black** (23.12.1) - Code formatter
- **flake8** (6.1.0) - Linting
- **mypy** (1.7.1) - Type checking

### Installation

```bash
# Install from requirements.txt
pip install -r requirements.txt

# Install IB API separately (see Interactive Brokers API section above)
```

## Verification

### System Verification Checklist

**1. Python Environment:**
```bash
python3.11 --version
# Expected: Python 3.11.x
```

**2. Virtual Environment:**
```bash
source venv/bin/activate
which python
# Expected: /Users/michaelmerrick/quanticity_capital/venv/bin/python
```

**3. PostgreSQL:**
```bash
psql --version
# Expected: psql (PostgreSQL) 16.10 (Homebrew)
```

**4. Redis:**
```bash
redis-cli ping
# Expected: PONG
```

**5. Dependencies:**
```bash
pip list
# Verify all packages from requirements.txt are installed
```

**6. IB API:**
```bash
python -c "import ibapi; print(ibapi.__version__)"
# Expected: 10.37.2

python -c "import google.protobuf; print('protobuf OK')"
# Expected: protobuf OK
```

### Service Status

All services have been verified as operational:
- ✓ Python 3.11 installed and venv configured
- ✓ PostgreSQL 16.10 installed and accessible
- ✓ Redis responding to ping commands
- ✓ IB API ready for integration

## Testing

### Running Tests

**All tests:**
```bash
pytest
```

**Integration tests only:**
```bash
pytest tests/integration/
```

**IB connection test (requires TWS/IB Gateway running):**
```bash
pytest tests/integration/test_ib_connection.py -v -s
```

**Direct test execution:**
```bash
python tests/integration/test_ib_connection.py
```

### Test Prerequisites

**For IB Integration Tests:**
- TWS or IB Gateway must be running
- API enabled in TWS settings
- Correct port configured (7497 for paper, 7496 for live)

## Development Workflow

### Initial Setup

1. **Clone repository and create virtual environment:**
   ```bash
   cd quanticity_capital
   python3.11 -m venv venv
   source venv/bin/activate
   ```

2. **Install dependencies:**
   ```bash
   pip install -r requirements.txt
   ```

3. **Install IB API:**
   ```bash
   # Download from https://interactivebrokers.github.io/
   # Extract to ~/Downloads/twsapi_macunix
   cd ~/Downloads/twsapi_macunix/IBJts/source/pythonclient
   python setup.py install
   ```

4. **Configure environment:**
   ```bash
   cp .env.example .env
   # Edit .env with your configuration
   ```

5. **Verify services:**
   ```bash
   redis-cli ping
   psql --version
   ```

6. **Run tests:**
   ```bash
   pytest
   ```

### Daily Development

1. **Activate environment:**
   ```bash
   source venv/bin/activate
   ```

2. **Start required services:**
   - Redis (if not running)
   - PostgreSQL (if not running)
   - TWS or IB Gateway (for IB integration work)

3. **Run application:**
   ```bash
   python src/main.py
   ```

## Trading Modes

### Paper Trading (Default)

- **Environment**: Testing/Development
- **Port**: 7497
- **Risk**: None - simulated trading
- **Configuration**: `IB_PORT=7497` in `.env`

### Live Trading

- **Environment**: Production
- **Port**: 7496
- **Risk**: Real money
- **Configuration**: `IB_PORT=7496` in `.env`

**⚠️ WARNING:** Always thoroughly test with paper trading before switching to live trading.

## Security Considerations

### Gitignored Files

The following files contain sensitive data and are gitignored:

- `.env` - Environment variables (credentials, API keys)
- `venv/` - Virtual environment
- `__pycache__/` - Python cache
- `*.pyc`, `*.pyo` - Compiled Python
- `.pytest_cache/` - Pytest cache
- `*.log` - Log files

### Best Practices

1. **Never commit `.env` file** - Use `.env.example` as template
2. **Use environment variables** - No hardcoded credentials
3. **Separate paper/live configs** - Different .env files for different environments
4. **Rotate credentials regularly** - Database passwords, API keys
5. **Limit API access** - Use localhost-only for IB API when possible

## Performance Considerations

### Resource Requirements

- **Memory**: 2GB minimum, 4GB recommended
- **CPU**: 2 cores minimum
- **Disk**: 1GB for application, additional for data storage
- **Network**: Stable connection for IB API

### Optimization

- Redis used for caching frequently accessed data
- PostgreSQL for persistent storage
- Async operations for IB API (threading)

## Monitoring & Logging

### TWS Logs

- **Location**: Help → Log Viewer in TWS
- **Contains**: Connection errors, API messages, TWS events

### Application Logs

- Implemented via `error()` callback in IB client
- Console output for development
- File logging for production (to be implemented)

## Troubleshooting

### Common Issues

**IB Connection Error 502:**
- TWS/IB Gateway not running
- API not enabled in settings
- Wrong port number
- Firewall blocking connection

**PostgreSQL Connection Failed:**
- PostgreSQL service not running: `brew services start postgresql@16`
- Wrong credentials in `.env`
- Database doesn't exist: `createdb quanticity_capital`

**Redis Connection Failed:**
- Redis service not running: `brew services start redis`
- Wrong port in configuration

**Import Errors:**
- Virtual environment not activated: `source venv/bin/activate`
- Dependencies not installed: `pip install -r requirements.txt`
- IB API not installed manually

## Platform Compatibility

**Current Platform:**
- **OS**: macOS (Darwin 24.6.0)
- **Python**: 3.11
- **Package Manager**: Homebrew

**Supported Platforms:**
- macOS (tested)
- Linux (should work with minor adjustments)
- Windows (requires different path handling)

## Version History

- **2025-10-03**: Initial infrastructure setup
  - Python 3.11 environment configured
  - PostgreSQL 16.10 installed
  - Redis configured
  - IB API integration implemented
  - Testing framework established

## References

- **PostgreSQL Docs**: https://www.postgresql.org/docs/16/
- **Redis Docs**: https://redis.io/documentation
- **IB API Docs**: https://interactivebrokers.github.io/tws-api/
- **pytest Docs**: https://docs.pytest.org/
