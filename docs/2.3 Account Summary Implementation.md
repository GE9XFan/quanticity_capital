# 2.3 Account Summary Implementation

## Overview

This document describes the implementation of account summary and account updates functionality for Interactive Brokers API integration.

**Status:** ✓ Fully implemented and tested (MRO bug fixed 2025-10-03)
**API Version:** 10.37.2
**Last Updated:** 2025-10-03 19:45
**Related Documents:**
- `docs/2.1 Interactive Brokers Connection.md` - Connection basics
- `docs/3.1 Data Storage Strategy.md` - Field mappings and storage
- `docs/CRITICAL_BUG_FIX_AND_TESTING.md` - Bug fixes and testing

---

## ⚠️ CRITICAL: Method Resolution Order (MRO) Bug

**The Bug:** If `IBClient` inherits from `EWrapper` before `AccountMixin`, callbacks won't work!

```python
# ❌ WRONG - EWrapper's empty callbacks override ours:
class IBClient(EWrapper, EClient, AccountMixin):

# ✅ CORRECT - AccountMixin comes first:
class IBClient(AccountMixin, EWrapper, EClient):
```

**Impact:** With wrong order, IB sends data but callbacks do nothing → NO storage!

**File:** `src/brokers/ib/client.py:14`

**Verification:** If Redis has 0 keys after running tests, check the MRO!

---

## Table of Contents

1. [Introduction](#introduction)
2. [IB API Methods](#ib-api-methods)
3. [Implementation Architecture](#implementation-architecture)
4. [Usage Examples](#usage-examples)
5. [Testing](#testing)
6. [Storage Strategy](#storage-strategy)
7. [Account Summary Tags](#account-summary-tags)
8. [Account Value Keys](#account-value-keys)
9. [Troubleshooting](#troubleshooting)

---

## Introduction

Interactive Brokers provides two main methods for retrieving account and portfolio data:

1. **reqAccountSummary** - Subscription to account summary (multi-account support)
2. **reqAccountUpdates** - Subscription to detailed account updates (single account)

### Key Differences

| Feature | reqAccountSummary | reqAccountUpdates |
|---------|------------------|-------------------|
| **Accounts** | Multiple ("All" or group) | Single account only |
| **Update Frequency** | Every 3 minutes | Every 3 minutes or position change |
| **Active Subscriptions** | Max 2 simultaneous | Max 1 simultaneous |
| **Data Included** | Summary tags only | Account values + portfolio |
| **Portfolio Details** | No | Yes (positions, P&L) |

---

## IB API Methods

### reqAccountSummary

**Purpose:** Subscribe to account summary data

**Signature:**
```python
def req_account_summary(self, req_id: int, group: str = "All", tags: str = None):
```

**Parameters:**
- `req_id` (int): Unique request identifier
- `group` (str): "All" or specific account group name
- `tags` (str): Comma-separated tag list or None for all tags

**Callbacks:**
- `accountSummary(reqId, account, tag, value, currency)` - Receives data
- `accountSummaryEnd(reqId)` - Signals end of initial data

**Important Limitations:**
- Only 2 active subscriptions allowed at once
- Updates every 3 minutes (cannot be changed)
- Initial call returns all values, then only changes
- Not available for IBroker accounts with 50+ subaccounts

---

### reqAccountUpdates

**Purpose:** Subscribe to detailed account and portfolio updates

**Signature:**
```python
def req_account_updates(self, subscribe: bool, account: str):
```

**Parameters:**
- `subscribe` (bool): True to start, False to stop
- `account` (str): Account identifier (e.g., "U123456")

**Callbacks:**
- `updateAccountValue(key, val, currency, accountName)` - Receives account values
- `updatePortfolio(contract, position, ...)` - Receives portfolio updates
- `updateAccountTime(timeStamp)` - Receives update timestamp
- `accountDownloadEnd(accountName)` - Signals end of download

**Important Limitations:**
- Only ONE account can be subscribed at a time
- Second subscription cancels the first automatically
- Updates every 3 minutes or on position change
- Portfolio data included

---

## Implementation Architecture

### Class Structure

```
IBClient (EWrapper, EClient, AccountMixin)
    └── AccountMixin
            ├── req_account_summary()
            ├── req_account_updates()
            ├── accountSummary() callback
            ├── updateAccountValue() callback
            ├── updatePortfolio() callback
            └── storage integration
```

### Data Flow

```
IB API Callback
    ↓
Pydantic Model Validation
    ↓
├─→ Redis (Real-time cache)
│   TTL: 180s (summary), 300s (positions)
│
└─→ PostgreSQL (Historical persistence)
    Important tags only, 2-year retention
```

### File Structure

```
src/brokers/ib/
├── models.py           # Pydantic data models
├── account.py          # AccountMixin implementation
└── client.py           # IBClient with AccountMixin

src/storage/
├── redis_client.py     # Redis operations
└── postgres_client.py  # PostgreSQL operations

tests/integration/
└── test_account_summary.py  # Integration tests
```

---

## Usage Examples

### Basic Account Summary

```python
from src.brokers.ib.client import IBClient
from src.brokers.ib.config import IBConfig
from src.storage.redis_client import RedisClient
from src.storage.postgres_client import PostgresClient
import threading

# Initialize clients
config = IBConfig.from_env()
redis_client = RedisClient()
postgres_client = PostgresClient()

# Create IB client with storage
client = IBClient(redis_client=redis_client, postgres_client=postgres_client)

# Connect
client.connect(config.host, config.port, config.client_id)
thread = threading.Thread(target=client.run, daemon=True)
thread.start()

# Wait for connection
if client.wait_for_connection(timeout=10):
    # Request account summary
    req_id = 9001
    client.req_account_summary(req_id, "All", tags=None)

    # Wait for data (initial callback may take a few seconds)
    time.sleep(10)

    # Retrieve from cache
    account_id = "U123456"
    net_liq = client.get_account_summary_from_cache(account_id, "NetLiquidation")
    print(f"Net Liquidation: {net_liq['value']} {net_liq['currency']}")

    # Cancel when done
    client.cancel_account_summary(req_id)

client.disconnect()
```

### Account Updates with Portfolio

```python
# ... (connect as above)

if client.wait_for_connection(timeout=10):
    account_id = "U123456"

    # Request account updates
    client.req_account_updates(True, account_id)

    # Wait for data
    time.sleep(15)

    # Get positions from cache
    positions = client.get_all_positions_from_cache(account_id)
    for contract_id, position in positions.items():
        print(f"{position['symbol']}: {position['position']} @ {position['avg_cost']}")

    # Cancel when done
    client.cancel_account_updates()

client.disconnect()
```

### Retrieving Historical Data

```python
from datetime import datetime, timedelta
from src.storage.postgres_client import PostgresClient

postgres_client = PostgresClient()

# Get account summary history
account_id = "U123456"
end_date = datetime.now()
start_date = end_date - timedelta(days=30)

history = postgres_client.get_account_summary_history(
    account=account_id,
    tag="NetLiquidation",
    start_date=start_date,
    end_date=end_date
)

for record in history:
    print(f"{record['timestamp']}: {record['value']} {record['currency']}")
```

---

## Testing

### Running Integration Tests

**Prerequisites:**
1. TWS/IB Gateway running on port 7497 (paper trading)
2. API enabled in TWS settings
3. Redis running
4. PostgreSQL running with migrations applied
5. Set `IB_TEST_ACCOUNT` in `.env` (your paper trading account)

**Run all account summary tests:**
```bash
pytest tests/integration/test_account_summary.py -v -s
```

**Run specific test:**
```bash
pytest tests/integration/test_account_summary.py::TestAccountSummary::test_account_summary_request -v -s
```

**Direct execution:**
```bash
python tests/integration/test_account_summary.py
```

### Test Coverage

✓ **Test 1:** Redis storage operations
✓ **Test 2:** PostgreSQL storage operations
✓ **Test 3:** Account summary request (live API)
✓ **Test 4:** Account updates request (live API)

---

## Storage Strategy

### Redis (Real-time Cache)

**Account Summary:**
```
Key: ib:account:{account}:summary:{tag}
TTL: 180 seconds (3 minutes)
Value: String (numeric value)
Currency: ib:account:{account}:summary:{tag}:currency
```

**Positions:**
```
Key: ib:account:{account}:positions
TTL: 300 seconds (5 minutes)
Type: Hash
Fields: {contract_id}: JSON position data
```

**Example:**
```redis
SET ib:account:U123456:summary:NetLiquidation "1000000.5000" EX 180
SET ib:account:U123456:summary:NetLiquidation:currency "USD" EX 180

HSET ib:account:U123456:positions 8314 '{"symbol":"IBM","position":100,...}'
EXPIRE ib:account:U123456:positions 300
```

### PostgreSQL (Historical Persistence)

**Important Tags Persisted:**
- NetLiquidation
- TotalCashValue
- BuyingPower
- AvailableFunds
- ExcessLiquidity
- GrossPositionValue
- InitMarginReq
- MaintMarginReq
- Cushion
- Leverage

**All Other Data:**
- Account values (all keys)
- Positions (on change)
- Contracts (upserted)

**Retention:** 2 years (3 years for daily P&L)

---

## Account Summary Tags

### Most Important Tags

| Tag | Description | Use Case |
|-----|-------------|----------|
| **NetLiquidation** | Total account value | Overall account size |
| **BuyingPower** | Available buying power | Position sizing |
| **AvailableFunds** | Funds available for trading | Cash management |
| **ExcessLiquidity** | Margin cushion | Risk management |
| **GrossPositionValue** | Total position value | Exposure tracking |
| **Cushion** | Excess liquidity % | Margin safety |
| **InitMarginReq** | Initial margin required | Position requirements |
| **MaintMarginReq** | Maintenance margin | Liquidation risk |

### Complete Tag List

See IB API documentation or `docs/3.1 Data Storage Strategy.md` for complete list of 50+ available tags.

---

## Account Value Keys

### Most Important Keys

| Key | Description | Type |
|-----|-------------|------|
| **AccountReady** | Account status (true/false) | Boolean |
| **NetLiquidation** | Account value | Numeric |
| **TotalCashValue** | Total cash | Numeric |
| **BuyingPower** | Buying power | Numeric |
| **EquityWithLoanValue** | Equity + loan | Numeric |
| **GrossPositionValue** | Position value | Numeric |

**Important:** Check `AccountReady` key. If false, subsequent values may be out of date (IB server resetting).

### Complete Key List

See `docs/3.1 Data Storage Strategy.md` for complete list of 100+ account value keys with descriptions.

---

## Troubleshooting

### Issue: No Data Received

**Symptoms:**
- `accountSummary()` never called
- Empty Redis cache

**Causes:**
- TWS not fully logged in
- Account not accessible
- Invalid group name
- API subscription limit reached (2 max)

**Resolution:**
1. Check TWS is fully logged in (no dialogs)
2. Verify account access in TWS
3. Cancel existing subscriptions
4. Use "All" for group parameter

---

### Issue: AccountReady = false

**Symptoms:**
- `AccountReady` key returns "false"
- Inconsistent account values

**Cause:**
- IB server is resetting account data

**Resolution:**
- Wait for `AccountReady` = "true"
- Discard values received during reset
- Implementation already handles this

---

### Issue: Position Updates Not Received

**Symptoms:**
- `updatePortfolio()` not called
- No position data in Redis

**Causes:**
- No positions in account
- Already subscribed to different account
- Position hasn't changed (updates only on change)

**Resolution:**
1. Verify positions exist in TWS
2. Cancel previous subscription
3. Wait for position change or 3-minute update

---

### Issue: PostgreSQL Insert Fails

**Symptoms:**
- Error: "foreign key violation"
- Contract insert fails

**Cause:**
- Contract not inserted before position
- Migration not run

**Resolution:**
```bash
# Verify migrations run
psql -d quanticity_capital -c "\dt"

# Check contract exists
psql -d quanticity_capital -c "SELECT * FROM contracts WHERE con_id = 8314"

# Upsert contract manually if needed
```

---

## Performance Considerations

### Update Frequencies

- **Account Summary:** Every 3 minutes (IB limitation)
- **Account Updates:** Every 3 minutes OR on position change
- **Redis TTL:** Slightly longer than update frequency (buffer)

### Resource Usage

**Redis:**
- Memory per account: ~100 KB (summary + positions)
- Negligible CPU impact

**PostgreSQL:**
- Inserts per update: 10-50 (depends on positions)
- Recommend indexing on timestamp columns

### Optimization Tips

1. **Selective Tag Subscription:**
   ```python
   # Only request needed tags
   tags = "NetLiquidation,BuyingPower,AvailableFunds"
   client.req_account_summary(req_id, "All", tags)
   ```

2. **Cache Hit Rate:**
   - Monitor Redis hit rate (target: >95%)
   - Adjust TTL if needed

3. **Database Growth:**
   - Run cleanup function daily
   - Monitor table sizes
   - Archive old data if needed

---

## Next Steps

After implementing account summary:

1. ✓ Account Summary - **COMPLETE**
2. → **Next:** Positions (reqPositions) - Document 2.4
3. → P&L (reqPnL, reqPnLSingle) - Document 2.5

---

## References

- **IB API Docs:** https://interactivebrokers.github.io/tws-api/
- **Account Summary:** https://interactivebrokers.github.io/tws-api/account_summary.html
- **Account Updates:** https://interactivebrokers.github.io/tws-api/account_updates.html
- **Field Mappings:** `docs/3.1 Data Storage Strategy.md`

---

**End of Document**

---

## Troubleshooting

### Bug #1: No Data in Redis (MRO Bug)

**Symptoms:**
- Test shows "✅ Connected" but Redis has 0 keys
- `account_values` table has 0 records
- No errors, but no data captured

**Root Cause:** Wrong inheritance order in `IBClient`

**Fix:**
```python
# File: src/brokers/ib/client.py:14
class IBClient(AccountMixin, EWrapper, EClient):  # ✅ AccountMixin FIRST
```

**Why:** Python's Method Resolution Order (MRO) goes left-to-right. If `EWrapper` comes first, its empty `accountSummary()` callback is used instead of our implementation.

---

### Bug #2: Redis Not Populated (Storage Order Bug)

**Symptoms:**
- Callbacks execute
- PostgreSQL has data
- But Redis is empty

**Root Cause:** Redis storage after service check

**Fix:**
```python
# File: src/brokers/ib/account.py:237
# Store in Redis FIRST
if self.redis_client:
    self.redis_client.store_account_summary(...)

# THEN delegate to service
if self.account_service:
    handled = self.account_service.handle_account_summary(...)
```

---

### Bug #3: Data Lost (Service Return Bug)

**Symptoms:**
- Callbacks execute
- But account_values has 0 records
- Deduplication is dropping everything

**Root Cause:** `_handled()` returns True even when not persisting

**Fix:**
```python
# File: src/services/account_service.py:361
def _handled(self, persisted: bool) -> bool:
    return persisted  # Return actual status, not if clients exist
```

---

### Bug #4: Crash on Non-Numeric Values (Decimal Exception)

**Symptoms:**
- Connection drops after receiving "INDIVIDUAL" or "true"
- Error: `decimal.InvalidOperation: [<class 'decimal.ConversionSyntax'>]`

**Root Cause:** `numeric_value` property didn't catch `decimal.InvalidOperation`

**Fix:**
```python
# File: src/brokers/ib/models.py:6,29
import decimal  # Add to imports

@property
def numeric_value(self) -> Optional[Decimal]:
    try:
        return Decimal(self.value)
    except (ValueError, TypeError, decimal.InvalidOperation):  # Add InvalidOperation
        return None
```

---

### Verification Steps

**Check if bugs are fixed:**
```bash
# 1. Run test
venv/bin/python tests/integration/test_REAL_ib_data_flow.py

# Should see:
# ✅ TEST PASSED: Data flowing from IB to database
# - 48 summary callbacks received
# - 190 account value callbacks received

# 2. Check Redis
redis-cli KEYS "ib:account:*" | wc -l
# Expected: 20-50

# 3. Check PostgreSQL
psql -d quanticity_capital -c "SELECT COUNT(*) FROM account_values WHERE account = 'DUH923436';"
# Expected: 190+ (NOT 0!)
```

**All 4 bugs verified fixed:** 2025-10-03 with account DUH923436 ($250,015.68)

