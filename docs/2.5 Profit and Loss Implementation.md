# 2.5 Profit and Loss Implementation

## Overview

Interactive Brokers exposes two dedicated PnL feeds:

- `reqPnL` ‚Üí `pnl` callback (account-level daily/unrealised/realised figures).
- `reqPnLSingle` ‚Üí `pnlSingle` callback (contract-level metrics including `pos` and `value`).

Our implementation wraps these subscriptions inside `AccountMixin` and hands off to `AccountService` for caching and persistence.

---

## Usage

```python
account_req = 9001
position_req = 9002

client.req_pnl(account_req, account_id, model_code="")
client.req_pnl_single(position_req, account_id, model_code="", con_id=12345)

# ... when done
client.cancel_pnl(account_req)
client.cancel_pnl_single(position_req)
```

`model_code` is optional (empty string for default account model). Each request ID must be unique per subscription.

---

## Callback Handling

- Account-level: values converted into `AccountPnL` model, cached in Redis (`ib:account:{account}:pnl`) and inserted into `pnl_daily` when changed or when `pnl_persist_interval` seconds have elapsed.
- Position-level: values converted into `PositionPnL`, cached under `ib:account:{account}:position:{con_id}:pnl`, and stored in `pnl_positions` with the same interval logic.

Redis payload example:

```json
{
  "daily_pnl": "5000.50",
  "unrealized_pnl": "12000.00",
  "realized_pnl": "3000.00",
  "last_update": "2024-01-01T12:00:00Z"
}
```

PostgreSQL snapshot (`pnl_daily` / `pnl_positions`) includes a timestamp and respects the retention policy defined in `cleanup_old_data()`.

---

## Testing

- Unit coverage: `tests/unit/test_account_service.py::test_account_pnl_persistence_respects_interval` and `test_position_pnl_persists_on_change`.
- Live integration (requires IB Gateway + env): `tests/integration/test_pnl.py` guarded by `RUN_IB_PNL_TESTS`, `IB_TEST_ACCOUNT`, and `IB_TEST_CONID`.

---

## Operational Notes

- IB resets `dailyPnL` according to TWS settings (typically at market open). Persisted historical data supports after-the-fact reconciliation.
- Position-level feed requires specifying a `conId`. Re-use request IDs cautiously; cancel before re-subscribing.
- High-frequency updates (~1s) can produce large datasets; tune `pnl_persist_interval` via `AccountService` constructor if storage pressure arises.

---

## üêõ Bugs Fixed (2025-10-03)

### Bug #3: Redundant Decimal Conversion for `pos` Field

**File:** `src/brokers/ib/account.py:585-592`

**Problem:**
The `pnlSingle` callback was converting the `pos` parameter to Decimal unnecessarily - it's already a Decimal from IB API.

```python
# ‚ùå REDUNDANT
position=Decimal(str(pos)) if pos is not None else None
```

**Fix:**
```python
# ‚úÖ CORRECT - pos is already Decimal from IB
position=pos if pos is not None else None
```

**Impact:** Minor - no data loss, but unnecessary conversion overhead.

---

### Bug #4: PostgreSQL ON CONFLICT Clause for Real-Time P&L

**File:** `src/storage/postgres_client.py:380-406`

**Problem:**
The `insert_daily_pnl()` method was using an ON CONFLICT clause that only works when `is_eod_snapshot = TRUE`, causing errors for real-time P&L inserts (`is_eod = FALSE`).

```python
# ‚ùå WRONG - Only works for is_eod=TRUE
ON CONFLICT (account, date, is_eod_snapshot)
WHERE is_eod_snapshot = TRUE
```

**Error:** `there is no unique or exclusion constraint matching the ON CONFLICT specification`

**Fix:**
Separate SQL for EOD vs real-time snapshots:

```python
if is_eod:
    # EOD: UPSERT (only one per day)
    sql = """... ON CONFLICT (account, date) WHERE is_eod_snapshot = TRUE ..."""
else:
    # Real-time: Just INSERT (multiple per day allowed)
    sql = """INSERT INTO pnl_daily ..."""
```

**Impact:** Real-time P&L updates were failing to persist to PostgreSQL.

---

## ‚úÖ Verification Status

**Date:** 2025-10-03
**Test:** `tests/integration/test_COMPREHENSIVE_data_verification.py`
**Result:** ‚úÖ All bugs fixed

**Verified:**
- Account P&L persists to Redis correctly
- Account P&L persists to PostgreSQL correctly (both real-time and EOD)
- Position P&L uses correct Decimal types
- No precision loss in P&L calculations
- All 5 P&L fields captured correctly (pos, dailyPnL, unrealizedPnL, realizedPnL, value)

